---
title: "Figure 1"
output: html_document
chunk_output_type: console
---

```{r setup, include = FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, autodep = knitr::dep_prev())
source(here::here('r/prerequisites.R'))
```

### Panel B

The rate of compound mutations (22.9% of all tumors) compared to a simulated background rate.

```{r panel_b}

## load data from permutations
perm <- readRDS(here::here('data/observed_vs_expected_compounds_impact_precalculated.rds'))
obs <- perm$obs_all
exp <- median(perm$dat_all$prop)

## plot results (figure 1c in paper)
perm$dat$group <- 'All samples'
plot_dat <- perm$dat
plot_dat$data <- 'Randomly shuffled'
plot_dat$prop <- plot_dat$prop * 100
obs_dat <- data.table(group='All samples')
obs_dat$prop <- perm$obs*100
obs_dat$data <- 'Observed'
pd <- rbind(plot_dat, obs_dat, fill=T)
x <- break_axis(pd$prop,maxlower=16,minupper=22,lowerticksize=1,upperticksize=1,ratio_lower_to_upper=0.5)
pd$prop2 <- x$newy
expected_color <- c('black','red')
names(expected_color) <- c('Randomly shuffled','Observed')

p <- ggplot(pd,aes(x=prop2)) +
    geom_histogram(binwidth=0.1,aes(fill=data),color='white',size=0.2) +
    geom_vline(data=pd[data=='Observed',],aes(xintercept=prop2),color='red',linetype='dashed',size=0.5) +
    scale_fill_manual(values=expected_color,name=NULL) +
    scale_x_continuous(breaks=c(x$breaks,18), labels=c(x$labels,24), limits=c(13.8,18.1)) +
    scale_y_continuous(expand=c(0,0)) +
    labs(x='Percentage',y='100,000 Random shuffles',title=NULL) +
    theme_std(base_size=14) +
    theme(legend.position='none')
p

```

### Panel C

The enrichment or lackthereof for compound mutations as a function of tumor mutational burden.

```{r panel_c}

## extract/merge the shuffled compound rate
l <- readRDS(here::here('data/observed_vs_expected_compounds_per_tmb_impact_precalculated.rds'))

burdens <- 1:50


extract_shuffled_data <- function(burden, l) {
    out <- data.table(mu=l[[burden]]$mu, lwr=l[[burden]]$lwr, upr=l[[burden]]$upr, 
    burden=l[[burden]]$burden, obs=l[[burden]]$obs, N=l[[burden]]$samples,p=l[[burden]]$p)
    out
}
ldat <- lapply(burdens, extract_shuffled_data, l)
dat <- rbindlist(ldat)
dat$nlog10p <- -log10(dat$p)
dat$nlog10p[dat$nlog10p>5] <- 5

## plot
p.pvals <- ggplot(dat,aes(x=burden,y=nlog10p)) +
    geom_hline(yintercept=2,color='red',linetype='dashed',size=0.4) +
    geom_bar(stat='identity',width=0.9,fill='black') +
    scale_x_continuous(breaks=seq(0,40,by=5),limits=c(0,40.5),expand=c(0,0)) +
    scale_y_continuous(expand=c(0,0)) +
    labs(x=NULL,y='-log10(p)') +
    theme_std(base_size=14) +
    theme(axis.text.x=element_blank(),axis.ticks.x=element_blank(),axis.line.x=element_blank())

p.hist <- ggplot(dat,aes(x=burden,y=N)) +
    geom_bar(stat='identity',width=0.9,fill='black') +
    scale_x_continuous(breaks=seq(0,40,by=5),limits=c(0,40.5),expand=c(0,0)) +
    scale_y_continuous(expand=c(0,0)) +
    theme_std(base_size=14) +
    labs(x=NULL,y='# Samples')

plot_grid(p.pvals,p.hist,align='v',rel_heights=c(1,1),ncol=1,nrow=2)
```

### Panel D

Potential mechanisms leading to the acquisition of the compound mutations


```{r panel_d}

## generate data used for pie chart:
sample_info <- fread(here('data/data_clinical.txt'))

## categorize all samples in clinical data (including those with 0 mutations in MAF)
## according to cause of hypermutation or non-hypermutated
pol_samples <- sortunique(sample_info$Tumor_Sample_Barcode[sample_info$pol_signature==T & !is.na(sample_info$pol_signature)])
msi_samples <- sortunique(sample_info$Tumor_Sample_Barcode[sample_info$msi_high==T & !is.na(sample_info$msi_high)])
tmz_samples <- sortunique(sample_info$Tumor_Sample_Barcode[sample_info$tmz_signature==T & !is.na(sample_info$tmz_signature)])
mmr_samples <- sortunique(sample_info$Tumor_Sample_Barcode[sample_info$mmr_signature==T & !is.na(sample_info$mmr_signature)])

total_exclude <- sortunique(c(pol_samples, msi_samples, tmz_samples, mmr_samples))
normal_tmb_samples <- sample_info$Tumor_Sample_Barcode[sample_info$high_tmb==F & !is.na(sample_info$high_tmb)]
normal_tmb_samples <- normal_tmb_samples[normal_tmb_samples %nin% total_exclude]
high_tmb_samples <- sample_info$Tumor_Sample_Barcode[sample_info$high_tmb==T & !is.na(sample_info$high_tmb)]
other_high_tmb_samples <- high_tmb_samples[high_tmb_samples %nin% total_exclude]
tmp1 <- data.table(sample=normal_tmb_samples,group='Normal-TMB')
tmp2 <- data.table(sample=pol_samples,group='POLE-signature')
tmp3 <- data.table(sample=msi_samples,group='MSI-High')
tmp4 <- data.table(sample=tmz_samples,group='TMZ-signature')
tmp5 <- data.table(sample=mmr_samples,group='MMR-signature')
tmp6 <- data.table(sample=other_high_tmb_samples,group='Non-hypermutant, High-TMB')
tmp <- rbind(tmp1,tmp2,tmp3,tmp4,tmp5,tmp6)
tmp$group <- factor(tmp$group,levels=unique(tmp$group))
tmp <- tmp[order(sample,group),]
tmp <- tmp[!duplicated(sample),]
N <- nrow(tmp) # 31,461; 34,650 including samples with 0 mutations
N_patients <- length(sortunique(strtrim(sample_info$Tumor_Sample_Barcode,9))) # 28,689; 31,359 with 0-mut samples


## for each sample/gene combo, check for compound; resistance mutation; possible biallelic loss
summarize_sample_gene <- function(d) {
    compound <- nrow(d) > 1
    any_resistance <- any(d$putative_resistance_mutation,na.rm=T) & compound==T
    if(d$Role[1] %in% c('TSG','Oncogene/TSG') & sum(d$Variant_Classification %in% c('Nonsense_Mutation','Splice_Site','Frame_Shift_Del','Frame_Shift_Ins')) > 1) {
        prob_biallelic_loss_of_tsg <- T  
    } else {
        prob_biallelic_loss_of_tsg <- F
    }

    list(compound=compound,any_resistance=any_resistance,prob_biallelic_loss_of_tsg=prob_biallelic_loss_of_tsg)
} 
d <- fread(here('data/data_mutations.txt'),select=c('Tumor_Sample_Barcode','Hugo_Symbol','Variant_Classification','Role','putative_resistance_mutation'))
info <- d[,summarize_sample_gene(.SD),by=c('Tumor_Sample_Barcode','Hugo_Symbol')]
info2 <- merge(info, tmp, by.x='Tumor_Sample_Barcode', by.y='sample', all=T)
info2[is.na(compound),compound:=F]
info2[is.na(any_resistance),any_resistance:=F]
info2[is.na(prob_biallelic_loss_of_tsg),prob_biallelic_loss_of_tsg:=F]


## for each sample, check for any compounds and then assign putative source
summarize_sample <- function(d) {
    any.compound <- any(d$compound)
    any.resistance <- any(d$any_resistance)
    if(any.compound==F) {
        reason <- 'n/a'
    } else {
        reason <- 'Unexplained compound mutation'
        if(d$group[1]!='Normal-TMB') {
            reason <- as.character(d$group[1])
        } else if(any.resistance) {
            reason <- 'Known resistance mutation'
        } else if(any(d$prob_biallelic_loss_of_tsg==T)) {
            reason <- 'Probably biallelic-loss of TSG'
        }
    }
    list(any.compound=any.compound, reason=reason)
}
sample_result <- info2[,summarize_sample(.SD),by=Tumor_Sample_Barcode]


## make pie chart:
reason_levels <- c('n/a','Unexplained compound mutation','Probably biallelic-loss of TSG','Known resistance mutation','MSI-High',
                   'MMR-signature','TMZ-signature','POLE-signature','Non-hypermutant, High-TMB')
sample_result$reason <- factor(sample_result$reason,levels=reason_levels)


## theme for pie chart
piechart_theme <- theme_minimal()+
    theme_std(base_size=14) + 
    theme(
      axis.text.x=element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      panel.border = element_blank(),
      panel.grid=element_blank(),
      axis.ticks = element_blank(),
      axis.line.x = element_blank(),
      axis.line.y = element_blank()
)

## pie chart 1: any compounds/sample
tbl1 <- adt(prop.table(table(sample_result$any.compound)))
tbl1$`Compound mutations` <- '0'
tbl1$`Compound mutations`[tbl1$V1==T] <- '1+'
tbl1[,V1:=NULL]
names(tbl1)[1] <- 'prop'
tbl1$`Compound mutations` <- paste0(tbl1$`Compound mutations`, ' (',100*round(tbl1$prop,3),'%)')
mycols1 <- colors$compound
names(mycols1) <- tbl1$`Compound mutations`
samples_overall <- paste0('N=',N)
compound_samples_overall <- paste0('N=',sum(sample_result$any.compound))

pie  <- ggplot(tbl1, aes(x="", y=prop, fill=`Compound mutations`))+
    geom_bar(width = 1, stat = "identity") + 
    coord_polar("y", start=0) +
    piechart_theme +
    scale_fill_manual(values=mycols1,name=paste0('Compound mutations per sample\n(',samples_overall,')')) +
    ggtitle('Proportion of patients with any compound mutations')


## pie chart 2: possible explanation for compounds
tbl2 <- adt(prop.table(table(sample_result$reason[sample_result$any.compound==T])))
tbl2 <- tbl2[V1!='n/a',]
names(tbl2) <- c('reason','prop')
tbl2$reason <- paste0(tbl2$reason, ' (',100*round(tbl2$prop,3),'%)')
tbl2$reason <- factor(tbl2$reason,levels=rev(tbl2$reason))
mycols2 <- brewer.pal(8,'Paired')
names(mycols2) <- levels(tbl2$reason)

pie2 <- ggplot(tbl2, aes(x="", y=prop, fill=reason),color='black')+
    geom_bar(width = 1, stat = "identity") + 
    coord_polar("y", start=0) +
    piechart_theme +
    scale_fill_manual(values=mycols2,name=paste0('Putative explanation\n(',compound_samples_overall,')')) +
    ggtitle('Putative explanation')


plot_grid(pie,pie2,ncol=1,nrow=2)
```

### Panel E

Rate of compound mutations in oncogenes and TSGs

```{r panel_e}

## load mutation data
d <- fread(here('data/data_mutations.txt'),select=c('exclude','putative_resistance_mutation','Tumor_Sample_Barcode','Hugo_Symbol','Role'))
d <- d[exclude==F & putative_resistance_mutation==F,]
d$id <- paste(d$Tumor_Sample_Barcode,d$Hugo_Symbol)
tbl <- table.freq(d$id)
tbl$compound <- tbl$N > 1
tbl[,N:=NULL]
d <- merge(d, tbl, by.x='id', by.y='value', all.x=T)

## tabulate fraction of oncogene-mutant samples with a compound mutation
d_onc <- d[Role=='Oncogene',]
n_samples_onc <- length(unique(strtrim(d_onc$Tumor_Sample_Barcode,9)))
n_compound_onc <- length(unique(strtrim(d_onc$Tumor_Sample_Barcode[d_onc$compound==T],9)))
ci_onc <- binom.confint(n_compound_onc, n_samples_onc, methods='exact')

## tabulate fraction of tsgogene-mutant samples with a compound mutation
d_tsg <- d[Role=='TSG',]
n_samples_tsg <- length(unique(strtrim(d_tsg$Tumor_Sample_Barcode,9)))
n_compound_tsg <- length(unique(strtrim(d_tsg$Tumor_Sample_Barcode[d_tsg$compound==T],9)))
ci_tsg <- binom.confint(n_compound_tsg, n_samples_tsg, methods='exact')

## p-value based on two-sample z test for diff in proportions
tst <- prop.test(c(n_compound_onc,n_compound_tsg),c(n_samples_onc,n_samples_tsg))
pval <- tst$p.value
pval_label <- paste0('p=',prettyNum(pval,digits=1))

## plot
ci_onc$Role <- 'Oncogenes'
ci_tsg$Role <- 'TSGs'
ci <- adt(rbind(ci_onc, ci_tsg))
ci$label <- paste0(ci$x,'/',ci$n)
ci[,c('mean','lower','upper'):=list(100*mean,100*lower,100*upper)]

p <- ggplot(ci,aes(x=Role,y=mean)) +
    geom_bar(stat='identity',fill='black') +
    geom_errorbar(aes(min=lower,max=mean),color='white',size=0.5,width=0) +
    geom_errorbar(aes(min=mean,max=upper),color='black',size=0.5,width=0) +
    geom_signif(comparisons=list(c("Oncogenes", "TSGs")), y_position = 20, size=0.2, tip_length = 0.06, annotations=pval_label) + 
    scale_y_continuous(expand=c(0,0),limits=c(0,22)) +
    theme_std(base_size=14) +
    theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
    labs(x=NULL,y='% of cases with compound mutations',title=NULL)
p

```

### Panel F

Proportion of mutation type among compound mutations by cancer gene function

```{r panel_f}

## load phased data with pairwise-mutation comparison
d <- fread(here('data/data_mutations_phased.txt'),select=c('Tumor_Sample_Barcode','exclude','putative_resistance_mutation.1','putative_resistance_mutation.2',
                'truncating.1','truncating.2','Role','Hugo_Symbol'))
d <- d[exclude==F & putative_resistance_mutation.1==F & putative_resistance_mutation.2==F,]
d$Class <- ''
d[truncating.1==F & truncating.2==F,Class:='Non-truncating/Non-truncating']
d[(truncating.1==T & truncating.2==F | truncating.1==F & truncating.2==T),Class:='Non-truncating/Truncating']
d[truncating.1==T & truncating.2==T,Class:='Truncating/Truncating']
d <- d[Role %in% c('Oncogene','TSG'),]

## don't overcount 3+ mutation compound-mutations; using unique sample/gene/Class counts
d$id <- paste(d$Tumor_Sample_Barcode, d$Hugo_Symbol, d$Class)
d <- d[!duplicated(id),c('Tumor_Sample_Barcode','Hugo_Symbol','Class','Role','id'),with=F]
dd <- d
dd[Class!='Non-truncating/Non-truncating',Class:='1 or both are truncating']
dd$Class <- factor(dd$Class,levels=(c('Non-truncating/Non-truncating','1 or both are truncating')))
cols <- colors$barplot2col
names(cols) <- rev(levels(dd$Class))

## for each gene, get its singleton/compound counts
summarize_gene <- function(d) {
    n_missense_missense <- length(unique(strtrim(d$Tumor_Sample_Barcode[d$Class=='Non-truncating/Non-truncating'],9)))
    n_any_truncating <- length(unique(strtrim(d$Tumor_Sample_Barcode[d$Class=='1 or both are truncating'],9)))
    tbl <- list(`Non-truncating/Non-truncating`=n_missense_missense, `1 or both are truncating`=n_any_truncating)
    tbl
}
res <- dd[,summarize_gene(.SD),by=c('Role')]
role_order <- c('Oncogene','TSG')
pval <- fisher.test(res[,(2:3),with=F])$p.value
pval_label <- paste0('p=',pval)

res$Role <- factor(res$Role, levels=role_order)
res <- res[order(Role),]
res2 <- res
res2[,Role:=NULL]
res2 <- res2 / rowSums(res2)
res2 <- cbind(Role=role_order,res2)
dat2 <- melt(res2,id.var='Role')
dat2$Role <- factor(dat2$Role,levels=role_order)
dat2$value <- 100*dat2$value
ci <- binom.confint(res$`1 or both are truncating`,(res$`1 or both are truncating` + res$`Non-truncating/Non-truncating`),method='exact')
ci$Role <- res2$Role
ci$Role <- factor(ci$Role, levels=c('Oncogene','TSG'))
setnames(ci,'mean','value')
ci$value <- 100*ci$value
ci$lower <- 100*ci$lower
ci$upper <- 100*ci$upper

p <- ggplot(dat2, aes(x=Role,y=value)) +
    geom_bar(stat='identity',aes(fill=variable)) +
    geom_signif(comparisons=list(c("Oncogene", "TSG")), y_position =102, size=0.2, tip_length = 0, annotations=pval_label) + 
    scale_fill_manual(values=cols,name='Consequence') +
    geom_errorbar(data=ci,aes(min=lower,max=value),color='white',width=0) +
    geom_errorbar(data=ci,aes(min=value,max=upper),color='black',width=0) +
    scale_y_continuous(expand=c(0,0),limits=c(0,106)) +
    labs(x='Role in cancer',y='Percentage',title=NULL) +
    theme_std(base_size=14) +
    theme(legend.position='right',axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
p
```


